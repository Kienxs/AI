import os           # Import c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt
import time
import random
from datetime import datetime

import pandas as pd         # Th∆∞ vi·ªán Pandas ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu d·∫°ng b·∫£ng (DataFrame)
import numpy as np          # Th∆∞ vi·ªán Numpy ƒë·ªÉ th·ª±c hi·ªán c√°c ph√©p to√°n s·ªë h·ªçc hi·ªáu su·∫•t cao

# Th∆∞ vi·ªán Scikit-learn cho c√°c t√°c v·ª• h·ªçc m√°y
from sklearn.model_selection import train_test_split            # train_test_split: Chia d·ªØ li·ªáu th√†nh t·∫≠p hu·∫•n luy·ªán v√† t·∫≠p ki·ªÉm tra            
from sklearn.ensemble import RandomForestRegressor          # RandomForestRegressor: M√¥ h√¨nh R·ª´ng ng·∫´u nhi√™n cho b√†i to√°n h·ªìi quy (d·ª± ƒëo√°n gi√° tr·ªã li√™n t·ª•c)
from sklearn.metrics import mean_absolute_error, r2_score           # mean_absolute_error, r2_score: C√°c ch·ªâ s·ªë ƒë√°nh gi√° m√¥ h√¨nh h·ªìi quy

# Th∆∞ vi·ªán Selenium ƒë·ªÉ t·ª± ƒë·ªông h√≥a tr√¨nh duy·ªát (d√πng ƒë·ªÉ l·∫•y ·∫£nh t·ª´ Google Maps)
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options           
from webdriver_manager.chrome import ChromeDriverManager            # webdriver_manager: T·ª± ƒë·ªông t·∫£i v√† qu·∫£n l√Ω driver cho tr√¨nh duy·ªát Chrome

from PIL import Image           # PIL (Pillow): Th∆∞ vi·ªán x·ª≠ l√Ω ·∫£nh (d√πng ƒë·ªÉ m·ªü v√† x·ª≠ l√Ω ·∫£nh ch·ª•p m√†n h√¨nh)
from io import BytesIO, StringIO            # io: Th∆∞ vi·ªán x·ª≠ l√Ω I/O, d√πng ƒë·ªÉ chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu nh·ªã ph√¢n (PNG) th√†nh ƒë·ªëi t∆∞·ª£ng ·∫£nh v√† chu·ªói CSV th√†nh DataFrame

# =====================================================
# 0. CONFIG
# =====================================================

train_csv = """timestamp,avg_speed,green_time,rain,temp,event_flag,hour_of_day,day_of_week,is_holiday,motorbike_count,car_count,bus_count,flow_weighted
15/10/2025 04:00,56.0,30,0,26.0,0,4,3,0,155,43,8,207
15/10/2025 04:05,55.9,30,0,26.0,0,4,3,0,164,46,9,219
15/10/2025 04:10,55.8,30,0,26.0,0,4,3,0,171,48,9,228
15/10/2025 04:15,55.7,30,0,26.0,0,4,3,0,166,46,9,221
15/10/2025 04:20,55.6,30,0,26.0,0,4,3,0,152,42,8,202
15/10/2025 04:25,55.5,30,0,26.1,0,4,3,0,154,43,8,205
15/10/2025 04:30,55.4,30,0,26.1,0,4,3,0,155,43,8,206
15/10/2025 04:35,55.3,30,0,26.1,0,4,3,0,164,46,9,219
15/10/2025 04:40,55.2,30,0,26.1,0,4,3,0,157,44,8,209
15/10/2025 04:45,55.1,32,0,26.2,0,4,3,0,152,43,8,203
15/10/2025 04:50,55.0,32,0,26.2,0,4,3,0,153,43,8,204
15/10/2025 04:55,54.9,32,0,26.2,0,4,3,0,163,46,9,217
15/10/2025 05:00,54.5,35,0,26.3,0,5,3,0,157,44,8,209
15/10/2025 05:05,54.1,35,0,26.3,0,5,3,0,177,50,9,236
15/10/2025 05:10,53.7,35,0,26.4,0,5,3,0,197,55,11,263
15/10/2025 05:15,53.3,38,0,26.4,0,5,3,0,218,61,12,290
15/10/2025 05:20,52.8,38,0,26.5,0,5,3,0,238,66,13,317
15/10/2025 05:25,52.3,40,0,26.5,0,5,3,0,258,72,14,344
15/10/2025 05:30,51.8,40,0,26.6,0,5,3,0,263,74,14,351
15/10/2025 05:35,50.9,45,0,26.6,0,5,3,0,239,67,13,318
15/10/2025 05:40,49.9,45,0,26.7,0,5,3,0,244,68,13,325
15/10/2025 05:45,48.8,48,0,26.7,0,5,3,0,264,74,14,352
15/10/2025 05:50,47.7,50,0,26.8,0,5,3,0,359,101,19,479
15/10/2025 05:55,46.6,52,0,26.8,0,5,3,0,311,87,17,415
15/10/2025 06:00,45.0,55,0,27.0,0,6,3,0,310,87,17,413
15/10/2025 06:05,44.0,58,0,27.0,0,6,3,0,322,90,17,429
15/10/2025 06:10,43.0,60,0,27.1,0,6,3,0,331,93,18,441
15/10/2025 06:15,42.0,62,0,27.1,0,6,3,0,362,101,19,483
15/10/2025 06:20,41.0,64,0,27.2,0,6,3,0,386,108,21,515
15/10/2025 06:25,39.0,65,0,27.2,0,6,3,0,410,115,22,547
15/10/2025 06:30,38.0,66,0,27.3,0,6,3,0,428,120,23,571
15/10/2025 06:35,37.0,68,0,27.3,0,6,3,0,454,127,24,605
15/10/2025 06:40,36.0,70,0,27.4,0,6,3,0,462,130,25,616
15/10/2025 06:45,35.0,70,0,27.4,0,6,3,0,478,134,25,637
15/10/2025 06:50,34.0,72,0,27.5,0,6,3,0,494,138,26,658
15/10/2025 06:55,33.0,72,0,27.5,0,6,3,0,511,143,27,681
15/10/2025 07:00,32.0,75,0,27.6,0,7,3,0,519,145,28,692
15/10/2025 07:05,31.0,75,0,27.6,0,7,3,0,527,147,28,702
15/10/2025 07:10,24.0,75,0,27.7,0,7,3,0,548,154,29,731
15/10/2025 07:15,23.0,75,0,27.7,0,7,3,0,573,161,31,764
15/10/2025 07:20,22.0,72,0,27.8,0,7,3,0,585,164,31,780
15/10/2025 07:25,21.0,70,0,27.8,0,7,3,0,594,166,32,792
15/10/2025 07:30,20.0,75,0,27.9,0,7,3,0,609,171,33,813
15/10/2025 07:35,19.0,72,0,27.9,0,7,3,0,622,174,33,829
15/10/2025 07:40,18.0,70,0,28.0,0,7,3,0,632,177,34,842
15/10/2025 07:45,17.0,68,0,28.0,0,7,3,0,668,187,36,891
15/10/2025 07:50,16.0,66,0,28.1,0,7,3,0,683,191,36,911
15/10/2025 07:55,9.0,64,0,28.1,0,7,3,0,699,196,37,932
15/10/2025 08:00,8.0,62,0,28.2,0,8,3,0,694,194,37,925
15/10/2025 08:05,15.0,60,0,28.2,0,8,3,0,674,189,36,899
15/10/2025 08:10,16.0,58,0,28.3,0,8,3,0,642,180,34,856
15/10/2025 08:15,17.0,56,0,28.3,0,8,3,0,621,174,33,828
15/10/2025 08:20,18.0,54,0,28.4,0,8,3,0,592,166,32,790
15/10/2025 08:25,19.0,52,0,28.4,0,8,3,0,572,160,30,762
15/10/2025 08:30,20.0,50,0,28.5,0,8,3,0,551,154,29,734
15/10/2025 08:35,21.0,48,0,28.5,0,8,3,0,537,150,29,716
15/10/2025 08:40,22.0,46,0,28.6,0,8,3,0,516,145,28,688
15/10/2025 08:45,23.0,45,0,28.6,0,8,3,0,503,141,27,670
15/10/2025 08:50,24.0,45,0,28.7,0,8,3,0,482,135,26,643
15/10/2025 08:55,25.0,45,0,28.7,0,8,3,0,472,132,25,629
15/10/2025 09:00,26.0,45,0,28.8,0,9,3,0,464,130,25,618
15/10/2025 09:05,27.0,45,0,28.8,0,9,3,0,447,125,24,596
15/10/2025 09:10,28.0,45,0,28.9,0,9,3,0,416,116,22,554
15/10/2025 09:15,29.0,45,0,28.9,0,9,3,0,406,114,22,542
15/10/2025 09:20,30.0,42,0,29.0,0,9,3,0,397,111,21,529
15/10/2025 09:25,31.0,42,0,29.0,0,9,3,0,381,107,20,508
15/10/2025 09:30,32.0,42,0,29.1,0,9,3,0,357,100,19,476
15/10/2025 09:35,33.0,42,0,29.1,0,9,3,0,341,95,18,454
15/10/2025 09:40,34.0,40,0,29.2,0,9,3,0,347,97,18,462
15/10/2025 09:45,35.0,40,0,29.2,0,9,3,0,360,101,19,480
15/10/2025 09:50,36.0,40,0,29.3,0,9,3,0,374,105,20,498
15/10/2025 09:55,37.0,40,0,29.3,0,9,3,0,394,110,21,525
15/10/2025 10:00,38.0,40,0,29.4,0,10,3,0,414,116,22,552
15/10/2025 10:05,39.0,40,0,29.4,0,10,3,0,404,113,22,539
15/10/2025 10:10,40.0,40,0,29.5,0,10,3,0,380,106,20,506
15/10/2025 10:15,41.0,40,0,29.5,0,10,3,0,400,112,21,533
15/10/2025 10:20,42.0,40,0,29.6,0,10,3,0,420,118,22,560
15/10/2025 10:25,43.0,40,0,29.6,0,10,3,0,440,123,24,587
15/10/2025 10:30,44.0,40,0,29.7,0,10,3,0,461,129,25,614
15/10/2025 10:35,45.0,40,0,29.7,0,10,3,0,481,135,26,641
15/10/2025 10:40,44.0,40,0,29.8,0,10,3,0,501,140,27,668
15/10/2025 10:45,43.0,40,0,29.8,0,10,3,0,521,146,28,695
15/10/2025 10:50,42.0,40,0,29.9,0,10,3,0,542,152,29,722
15/10/2025 10:55,41.0,40,0,29.9,0,10,3,0,562,157,30,749
15/10/2025 11:00,40.0,40,0,30.0,0,11,3,0,582,163,31,776
15/10/2025 11:05,39.0,40,0,30.0,0,11,3,0,565,158,30,753
15/10/2025 11:10,38.0,40,0,30.1,0,11,3,0,548,153,29,730
15/10/2025 11:15,37.0,40,0,30.1,0,11,3,0,536,150,28,714
15/10/2025 11:20,36.0,40,0,30.2,0,11,3,0,513,144,27,684
15/10/2025 11:25,35.0,40,0,30.2,0,11,3,0,533,149,28,711
15/10/2025 11:30,34.0,40,0,30.3,0,11,3,0,554,155,30,738
15/10/2025 11:35,33.0,40,0,30.3,0,11,3,0,521,146,28,695
15/10/2025 11:40,32.0,40,0,30.4,0,11,3,0,502,141,27,670
15/10/2025 11:45,31.0,40,0,30.4,0,11,3,0,479,134,26,638
15/10/2025 11:50,30.0,40,0,30.5,0,11,3,0,458,128,24,611
15/10/2025 11:55,29.0,40,0,30.5,0,11,3,0,438,123,23,584
15/10/2025 12:00,28.0,40,0,30.6,0,12,3,0,418,117,22,557
15/10/2025 12:05,27.0,40,0,30.6,0,12,3,0,472,132,25,630
15/10/2025 12:10,26.0,40,0,30.7,0,12,3,0,452,127,24,603
15/10/2025 12:15,45.0,40,0,30.7,0,12,3,0,432,121,23,576
15/10/2025 12:20,46.0,40,0,30.8,0,12,3,0,412,115,22,549
15/10/2025 12:25,47.0,40,0,30.8,0,12,3,0,392,110,21,522
15/10/2025 12:30,48.0,40,0,30.9,0,12,3,0,371,104,20,495
15/10/2025 12:35,49.0,40,0,30.9,0,12,3,0,351,98,19,468
15/10/2025 12:40,50.0,40,0,31.0,0,12,3,0,331,93,18,441
15/10/2025 12:45,51.0,40,0,31.0,0,12,3,0,311,87,17,414
15/10/2025 12:50,52.0,40,0,31.1,0,12,3,0,365,102,19,487
15/10/2025 12:55,53.0,40,0,31.1,0,12,3,0,345,97,18,460
15/10/2025 13:00,54.0,40,0,31.2,0,13,3,0,325,91,17,433
15/10/2025 13:05,55.0,40,0,31.2,0,13,3,0,305,86,16,406
15/10/2025 13:10,56.0,40,0,31.3,0,13,3,0,284,80,15,379
15/10/2025 13:15,57.0,40,0,31.3,0,13,3,0,264,74,14,352
15/10/2025 13:20,58.0,40,0,31.4,0,13,3,0,244,68,13,325
15/10/2025 13:25,59.0,40,0,31.4,0,13,3,0,261,73,14,348
15/10/2025 13:30,60.0,40,0,31.5,0,13,3,0,278,78,15,370
15/10/2025 13:35,59.0,40,0,31.5,0,13,3,0,287,80,15,382
15/10/2025 13:40,58.0,40,0,31.6,0,13,3,0,303,85,16,404
15/10/2025 13:45,57.0,40,0,31.6,0,13,3,0,320,90,17,426
15/10/2025 13:50,56.0,40,0,31.7,0,13,3,0,306,86,16,408
15/10/2025 13:55,55.0,40,0,31.7,0,13,3,0,292,82,16,390
15/10/2025 14:00,54.0,40,0,31.8,0,14,3,0,279,78,15,372
15/10/2025 14:05,53.0,40,0,31.8,0,14,3,0,266,75,14,354
15/10/2025 14:10,52.0,40,0,31.9,0,14,3,0,252,71,13,336
15/10/2025 14:15,51.0,40,0,31.9,0,14,3,0,239,67,13,318
15/10/2025 14:20,50.0,40,0,32.0,0,14,3,0,255,71,14,340
15/10/2025 14:25,49.0,40,0,32.0,0,14,3,0,269,75,14,358
15/10/2025 14:30,48.0,40,0,32.1,0,14,3,0,275,77,15,367
15/10/2025 14:35,47.0,40,0,32.1,0,14,3,0,281,79,15,374
15/10/2025 14:40,46.0,40,0,32.2,0,14,3,0,296,83,16,395
15/10/2025 14:45,45.0,40,0,32.2,0,14,3,0,301,84,16,401
15/10/2025 14:50,44.0,40,0,32.3,0,14,3,0,306,86,16,408
15/10/2025 14:55,43.0,40,0,32.3,0,14,3,0,320,90,17,426
15/10/2025 15:00,42.0,40,0,32.4,0,15,3,0,333,93,18,444
15/10/2025 15:05,41.0,40,0,32.4,0,15,3,0,347,97,18,462
15/10/2025 15:10,40.0,40,0,32.5,0,15,3,0,360,101,19,480
15/10/2025 15:15,39.0,40,0,32.5,0,15,3,0,374,105,20,498
15/10/2025 15:20,38.0,40,0,32.6,0,15,3,0,394,110,21,525
15/10/2025 15:25,37.0,40,0,32.6,0,15,3,0,414,116,22,552
15/10/2025 15:30,36.0,40,0,32.7,0,15,3,0,434,122,23,579
15/10/2025 15:35,35.0,42,0,32.7,0,15,3,0,455,127,24,606
15/10/2025 15:40,34.0,42,0,32.8,0,15,3,0,475,133,25,633
15/10/2025 15:45,33.0,42,0,32.8,0,15,3,0,495,139,26,660
15/10/2025 15:50,32.0,42,0,32.9,0,15,3,0,515,144,28,687
15/10/2025 15:55,31.0,42,0,32.9,0,15,3,0,491,137,26,654
15/10/2025 16:00,30.0,45,0,32.5,0,16,3,0,481,135,26,641
15/10/2025 16:05,29.0,45,0,32.5,0,16,3,0,471,132,25,628
15/10/2025 16:10,28.0,45,0,32.1,0,16,3,0,484,135,26,645
15/10/2025 16:15,27.0,45,0,32.1,0,16,3,0,467,131,25,622
15/10/2025 16:20,26.0,48,0,31.7,0,16,3,0,487,136,26,649
15/10/2025 16:25,25.0,48,0,31.7,0,16,3,0,507,142,27,676
15/10/2025 16:30,24.0,50,0,31.3,0,16,3,0,527,147,28,703
15/10/2025 16:35,23.0,52,0,31.3,0,16,3,0,548,153,29,730
15/10/2025 16:40,22.0,55,0,30.9,0,16,3,0,538,151,28,717
15/10/2025 16:45,21.0,58,0,30.9,0,16,3,0,513,144,27,684
15/10/2025 16:50,20.0,60,0,30.5,0,16,3,0,524,147,28,699
15/10/2025 16:55,19.0,62,0,30.5,0,16,3,0,554,155,30,738
15/10/2025 17:00,18.0,65,0,30.1,0,17,3,0,563,158,30,750
15/10/2025 17:05,17.0,68,0,30.1,0,17,3,0,590,165,31,786
15/10/2025 17:10,16.0,70,0,29.7,0,17,3,0,610,171,33,813
15/10/2025 17:15,15.0,72,0,29.7,0,17,3,0,629,176,34,838
15/10/2025 17:20,14.0,75,0,29.3,0,17,3,0,663,186,35,884
15/10/2025 17:25,13.0,75,0,29.3,0,17,3,0,683,191,36,911
15/10/2025 17:30,9.0,75,0,28.9,0,17,3,0,718,201,38,957
15/10/2025 17:35,8.0,75,0,28.9,0,17,3,0,698,195,37,930
15/10/2025 17:40,15.0,75,0,28.5,0,17,3,0,677,190,36,903
15/10/2025 17:45,16.0,75,0,28.5,0,17,3,0,657,184,35,876
15/10/2025 17:50,17.0,72,0,28.1,0,17,3,0,637,178,34,849
15/10/2025 17:55,18.0,70,0,28.1,0,17,3,0,617,173,33,822
15/10/2025 18:00,19.0,68,0,27.7,0,18,3,0,596,167,32,795
15/10/2025 18:05,20.0,65,0,27.7,0,18,3,0,576,161,31,768
15/10/2025 18:10,21.0,62,0,27.3,0,18,3,0,556,156,30,741
15/10/2025 18:15,22.0,60,0,27.3,0,18,3,0,536,150,29,714
15/10/2025 18:20,23.0,58,0,26.9,0,18,3,0,515,144,27,687
15/10/2025 18:25,24.0,55,0,26.9,0,18,3,0,495,139,26,660
15/10/2025 18:30,25.0,52,0,26.5,0,18,3,0,475,133,25,633
15/10/2025 18:35,26.0,50,0,26.5,0,18,3,0,455,127,24,606
15/10/2025 18:40,27.0,48,0,26.4,0,18,3,0,509,143,27,679
15/10/2025 18:45,28.0,45,0,26.4,0,18,3,0,489,137,26,652
15/10/2025 18:50,29.0,42,0,26.3,0,18,3,0,469,132,25,625
15/10/2025 18:55,30.0,40,0,26.3,0,18,3,0,486,136,26,648
15/10/2025 19:00,31.0,38,0,26.2,0,19,3,0,510,143,27,680
15/10/2025 19:05,32.0,35,0,26.2,0,19,3,0,526,147,28,702
15/10/2025 19:10,33.0,35,0,26.1,0,19,3,0,558,156,30,744
15/10/2025 19:15,34.0,35,0,26.1,0,19,3,0,545,153,29,726
15/10/2025 19:20,35.0,35,0,26.0,0,19,3,0,531,149,28,708
15/10/2025 19:25,36.0,35,0,26.0,0,19,3,0,518,144,28,690
15/10/2025 19:30,37.0,35,0,25.9,0,19,3,0,504,141,27,672
15/10/2025 19:35,38.0,35,0,25.9,0,19,3,0,528,148,28,704
15/10/2025 19:40,39.0,35,0,25.8,0,19,3,0,552,155,29,736
15/10/2025 19:45,40.0,35,0,25.8,0,19,3,0,539,151,28,718
15/10/2025 19:50,41.0,35,0,25.7,0,19,3,0,551,154,29,734
15/10/2025 19:55,42.0,35,0,25.7,0,19,3,0,572,160,30,762
15/10/2025 20:00,43.0,35,0,25.6,0,20,3,0,563,158,30,751
15/10/2025 20:05,44.0,35,0,25.6,0,20,3,0,554,155,29,738
15/10/2025 20:10,45.0,35,0,25.5,0,20,3,0,533,149,28,711
15/10/2025 20:15,46.0,35,0,25.5,0,20,3,0,521,146,27,694
15/10/2025 20:20,47.0,35,0,25.4,0,20,3,0,503,141,27,671
15/10/2025 20:25,48.0,35,0,25.4,0,20,3,0,486,136,26,648
15/10/2025 20:30,49.0,35,0,25.3,0,20,3,0,467,131,25,622
15/10/2025 20:35,50.0,35,0,25.3,0,20,3,0,450,126,24,599
15/10/2025 20:40,51.0,35,0,25.2,0,20,3,0,421,118,22,561
15/10/2025 20:45,52.0,35,0,25.2,0,20,3,0,407,114,22,542
15/10/2025 20:50,53.0,35,0,25.1,0,20,3,0,398,111,21,530
15/10/2025 20:55,54.0,35,0,25.1,0,20,3,0,380,106,20,506
15/10/2025 21:00,55.0,35,0,25.0,0,21,3,0,368,103,20,491
15/10/2025 21:05,56.0,35,0,25.0,0,21,3,0,356,100,19,475
15/10/2025 21:10,57.0,35,0,25.0,0,21,3,0,341,96,18,455
15/10/2025 21:15,58.0,35,0,25.0,0,21,3,0,318,89,17,424
15/10/2025 21:20,59.0,35,0,24.9,0,21,3,0,323,91,17,431
15/10/2025 21:25,60.0,35,0,24.9,0,21,3,0,314,88,17,419
15/10/2025 21:30,59.0,35,0,24.9,0,21,3,0,305,85,16,407
15/10/2025 21:35,58.0,35,0,24.8,0,21,3,0,314,88,17,418
15/10/2025 21:40,57.0,35,0,24.8,0,21,3,0,314,88,17,419
15/10/2025 21:45,56.0,35,0,24.8,0,21,3,0,329,92,18,439
15/10/2025 21:50,55.0,35,0,24.7,0,21,3,0,316,89,17,421
15/10/2025 21:55,54.0,35,0,24.7,0,21,3,0,305,85,16,407
15/10/2025 22:00,53.0,35,0,24.7,0,22,3,0,290,81,15,386
15/10/2025 22:05,52.0,35,0,24.7,0,22,3,0,294,82,16,392
15/10/2025 22:10,51.0,35,0,24.6,0,22,3,0,301,84,16,401
15/10/2025 22:15,50.0,35,0,24.6,0,22,3,0,290,81,15,386
15/10/2025 22:20,49.0,35,0,24.6,0,22,3,0,279,78,15,372
15/10/2025 22:25,48.0,35,0,24.5,0,22,3,0,292,82,16,389
15/10/2025 22:30,47.0,35,0,24.5,0,22,3,0,301,84,16,401
15/10/2025 22:35,46.0,35,0,24.5,0,22,3,0,306,86,16,408
15/10/2025 22:40,47.0,35,0,24.5,0,22,3,0,293,82,16,391
15/10/2025 22:45,48.0,35,0,24.4,0,22,3,0,285,80,15,380
15/10/2025 22:50,49.0,35,0,24.4,0,22,3,0,272,76,14,362
15/10/2025 22:55,50.0,35,0,24.4,0,22,3,0,255,71,14,340
15/10/2025 23:00,51.0,35,0,24.4,0,23,3,0,249,70,13,332
15/10/2025 23:05,52.0,35,0,24.3,0,23,3,0,241,67,13,321
15/10/2025 23:10,53.0,35,0,24.3,0,23,3,0,234,65,12,312
15/10/2025 23:15,54.0,35,0,24.3,0,23,3,0,240,67,13,320
15/10/2025 23:20,55.0,35,0,24.3,0,23,3,0,226,63,12,301
15/10/2025 23:25,56.0,35,0,24.2,0,23,3,0,218,61,12,290
15/10/2025 23:30,57.0,35,0,24.2,0,23,3,0,236,66,12,314
15/10/2025 23:35,58.0,35,0,24.2,0,23,3,0,240,67,13,320
15/10/2025 23:40,59.0,35,0,24.2,0,23,3,0,257,72,14,343
15/10/2025 23:45,60.0,35,0,24.1,0,23,3,0,239,67,13,319
15/10/2025 23:50,59.0,35,0,24.1,0,23,3,0,230,64,12,306
15/10/2025 23:55,58.0,35,0,24.1,0,23,3,0,224,63,12,298""".strip()

BASE_DIR = os.path.dirname(os.path.abspath(__file__))

MAP_URL = "https://www.google.com/maps/@10.8492335,106.773857,21z"

# Danh s√°ch c√°c ƒê·∫∂C TR∆ØNG (Features) d√πng ƒë·ªÉ hu·∫•n luy·ªán/d·ª± ƒëo√°n
FEATURES = [
    "avg_speed", "green_time", "rain", "temp", "event_flag",
    "hour_of_day", "day_of_week", "is_holiday",
    "motorbike_count", "car_count", "bus_count", "minute"
]
# Bi·∫øn M·ª§C TI√äU (Target) c·∫ßn d·ª± ƒëo√°n (Ch·ªâ s·ªë l∆∞u l∆∞·ª£ng giao th√¥ng c√≥ tr·ªçng s·ªë)
TARGET = "flow_weighted"

# =====================================================
# 1. T·ªêC ƒê·ªò GOOGLE MAPS (t·ª´ m√†u)
# =====================================================

# H√†m ph√°t hi·ªán t·ªëc ƒë·ªô t·ª´ m√†u s·∫Øc c·ªßa ·∫£nh ch·ª•p Google Maps
def detect_map_speed_from_colors(img: Image.Image) -> int:
    # Chuy·ªÉn ·∫£nh th√†nh m·∫£ng NumPy
    arr = np.array(img)
    h, w, _ = arr.shape
    # C·∫Øt khu v·ª±c trung t√¢m c·ªßa ·∫£nh (gi·∫£ ƒë·ªãnh th√¥ng tin k·∫πt xe n·∫±m ·ªü trung t√¢m)
    crop = arr[h//3:2*h//3, w//3:2*w//3]
    # T√≠nh gi√° tr·ªã trung b√¨nh c·ªßa k√™nh ƒê·ªè (R), Xanh l√° (G), Xanh d∆∞∆°ng (B) trong khu v·ª±c c·∫Øt
    r, g, b = crop.mean(axis=(0, 1))

    # Logic ƒë∆°n gi·∫£n ƒë·ªÉ d·ª± ƒëo√°n t·ªëc ƒë·ªô d·ª±a tr√™n m√†u s·∫Øc trung b√¨nh (M√†u giao th√¥ng c·ªßa Google Maps)
    # Xanh l√° (Green): L∆∞u th√¥ng t·ªët (T·ªëc ƒë·ªô 50)
    if g > 150 and r < 120:
        return 50
    # Cam/V√†ng (Orange/Yellow): L∆∞u th√¥ng v·ª´a ph·∫£i (T·ªëc ƒë·ªô 30)
    if r > 200 and g > 160:
        return 30
    # ƒê·ªè (Red): L∆∞u th√¥ng k√©m (T·ªëc ƒë·ªô 15)
    if r > 200 and g < 120:
        return 15
    # ƒê·ªè ƒë·∫≠m (Dark Red): T·∫Øc ngh·∫Ωn n·∫∑ng (T·ªëc ƒë·ªô 10)
    if r > 150 and g < 80:
        return 10
    # M·∫∑c ƒë·ªãnh
    return 30


# H√†m l·∫•y t·ªëc ƒë·ªô v√† th·ªùi gian ƒë√®n xanh t·ª´ Google Maps (s·ª≠ d·ª•ng Selenium)
def get_google_maps_speed(url: str):
    # C·∫•u h√¨nh Chrome Options: Ch·∫°y ·ªü ch·∫ø ƒë·ªô ·∫©n (headless), t·∫Øt sandbox, t·ªëi ∆∞u h√≥a b·ªô nh·ªõ
    chrome_options = Options()
    chrome_options.add_argument("--headless")
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-dev-shm-usage")

    # Kh·ªüi t·∫°o WebDriver cho Chrome (t·ª± ƒë·ªông c√†i ƒë·∫∑t driver)
    driver = webdriver.Chrome(
        service=Service(ChromeDriverManager().install()),
        options=chrome_options
    )

    # Truy c·∫≠p URL
    driver.get(url)
    # Ch·ªù 5 gi√¢y ƒë·ªÉ trang web t·∫£i ho√†n t·∫•t (bao g·ªìm c·∫£ d·ªØ li·ªáu b·∫£n ƒë·ªì)
    time.sleep(5)

    # Ch·ª•p ·∫£nh m√†n h√¨nh d∆∞·ªõi d·∫°ng PNG
    png = driver.get_screenshot_as_png()
    # ƒê√≥ng tr√¨nh duy·ªát
    driver.quit()

    # M·ªü ·∫£nh t·ª´ d·ªØ li·ªáu nh·ªã ph√¢n (BytesIO)
    img = Image.open(BytesIO(png))
    # Ph√°t hi·ªán t·ªëc ƒë·ªô d·ª±a tr√™n m√†u s·∫Øc
    speed = detect_map_speed_from_colors(img)
    # Th·ªùi gian ƒë√®n xanh (gi·∫£ l·∫≠p l√† 60 gi√¢y, c√≥ th·ªÉ c·∫ßn l·∫•y t·ª´ ngu·ªìn kh√°c n·∫øu c√≥)
    green_time = 60
    return speed, green_time

# =====================================================
# 2. ∆Ø·ªöC T√çNH L∆Ø·ª¢NG XE
# =====================================================

# H√†m ∆∞·ªõc t√≠nh l∆∞·ª£ng xe (motorbike, car, bus) d·ª±a tr√™n t·ªëc ƒë·ªô trung b√¨nh
def estimate_traffic_counts(avg_speed):
    # Chu·∫©n h√≥a t·ªëc ƒë·ªô trong kho·∫£ng [0.1, 60]
    speed = max(0.1, min(avg_speed, 60))

    # Tr·∫£ v·ªÅ c√°c gi√° tr·ªã ng·∫´u nhi√™n d·ª±a tr√™n ng∆∞·ª°ng t·ªëc ƒë·ªô (m√¥ ph·ªèng d·ªØ li·ªáu)
    if speed >= 45:
        # L∆∞u th√¥ng t·ªët (s·ªë l∆∞·ª£ng xe th·∫•p)
        return random.randint(150, 500), random.randint(42, 94), random.randint(8, 22)
    elif speed >= 25:
        # L∆∞u th√¥ng v·ª´a ph·∫£i (s·ªë l∆∞·ª£ng xe trung b√¨nh)
        return random.randint(400, 625), random.randint(74, 177), random.randint(12, 28)
    elif speed >= 10:
        # L∆∞u th√¥ng k√©m (s·ªë l∆∞·ª£ng xe cao)
        return random.randint(525, 775), random.randint(127, 258), random.randint(24, 44)
    else:
        # T·∫Øc ngh·∫Ωn n·∫∑ng (s·ªë l∆∞·ª£ng xe r·∫•t cao)
        return random.randint(625, 820), random.randint(178, 280), random.randint(28, 51)

# =====================================================
# 3. TH√îNG TIN TH·ªúI TI·∫æT
# =====================================================

# H√†m l·∫•y th√¥ng tin th·ªùi ti·∫øt gi·∫£ l·∫≠p
def get_fake_weather():
    now = datetime.now()
    hour = now.hour

    # Logic gi·∫£ l·∫≠p nhi·ªát ƒë·ªô thay ƒë·ªïi theo gi·ªù trong ng√†y
    if 5 <= hour < 9:
        temp = random.uniform(24, 27)
    elif 9 <= hour < 15:
        temp = random.uniform(30, 35)
    elif 15 <= hour < 18:
        temp = random.uniform(28, 33)
    else:
        temp = random.uniform(24, 28)

    # Logic gi·∫£ l·∫≠p x√°c su·∫•t m∆∞a (rain) cao h∆°n v√†o bu·ªïi chi·ªÅu t·ªëi
    rain_prob = 0.3 if 15 <= hour <= 19 else 0.1
    # rain = 1 (c√≥ m∆∞a), 0 (kh√¥ng m∆∞a)
    rain = 1 if random.random() < rain_prob else 0

    return round(temp, 1), rain


# =====================================================
# 4. HU·∫§N LUY·ªÜN HO·∫∂C T·∫¢I M√î H√åNH
# =====================================================

# H√†m t·∫£i ho·∫∑c hu·∫•n luy·ªán m√¥ h√¨nh
def load_or_train_model():
    # ƒê·ªçc d·ªØ li·ªáu CSV m·∫´u t·ª´ chu·ªói (StringIO)
    df = pd.read_csv(StringIO(train_csv))
    # Chuy·ªÉn c·ªôt 'timestamp' sang ƒë·ªãnh d·∫°ng datetime (ng√†y/th√°ng/nƒÉm tr∆∞·ªõc)
    df["timestamp"] = pd.to_datetime(df["timestamp"], dayfirst=True)
    # Tr√≠ch xu·∫•t 'minute' t·ª´ timestamp (ƒë∆∞·ª£c th√™m v√†o danh s√°ch FEATURES)
    df["minute"] = df["timestamp"].dt.minute

    # ƒê·ªãnh nghƒ©a ma tr·∫≠n ƒë·∫∑c tr∆∞ng X v√† vector m·ª•c ti√™u y
    X = df[FEATURES]
    y = df[TARGET]

    # Chia d·ªØ li·ªáu: 80% hu·∫•n luy·ªán, 20% ki·ªÉm tra
    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=0.2, random_state=42
    )

    # Kh·ªüi t·∫°o m√¥ h√¨nh Random Forest Regressor
    model = RandomForestRegressor(
        n_estimators=150,         # S·ªë l∆∞·ª£ng c√¢y trong r·ª´ng
        max_depth=8,              # ƒê·ªô s√¢u t·ªëi ƒëa c·ªßa m·ªói c√¢y
        min_samples_split=10,     # S·ªë m·∫´u t·ªëi thi·ªÉu ƒë·ªÉ ph√¢n chia n√∫t
        min_samples_leaf=5,       # S·ªë m·∫´u t·ªëi thi·ªÉu ·ªü n√∫t l√°
        max_features="sqrt",      # S·ªë l∆∞·ª£ng ƒë·∫∑c tr∆∞ng t·ªëi ƒëa ƒë∆∞·ª£c xem x√©t
        bootstrap=True,           # S·ª≠ d·ª•ng k·ªπ thu·∫≠t bootstrap (l·∫•y m·∫´u ng·∫´u nhi√™n c√≥ thay th·∫ø)
        max_samples=0.8,          # Ch·ªâ s·ª≠ d·ª•ng 80% m·∫´u cho m·ªói c√¢y (gi√∫p gi·∫£m ph∆∞∆°ng sai)
        random_state=42
    )

    # Hu·∫•n luy·ªán m√¥ h√¨nh
    model.fit(X_train, y_train)
    # D·ª± ƒëo√°n tr√™n t·∫≠p ki·ªÉm tra
    y_pred = model.predict(X_test)

    # In c√°c ch·ªâ s·ªë ƒë√°nh gi√° (MAE: Sai s·ªë tuy·ªát ƒë·ªëi trung b√¨nh, R2: H·ªá s·ªë x√°c ƒë·ªãnh)
    print("MAE:", mean_absolute_error(y_test, y_pred))
    print("R2 :", r2_score(y_test, y_pred))

    return model

# =====================================================
# 5. D·ª∞ ƒêO√ÅN TH·ªúI GIAN TH·ª∞C
# =====================================================

# H√†m d·ª± ƒëo√°n l∆∞u l∆∞·ª£ng giao th√¥ng theo th·ªùi gian th·ª±c
def predict_realtime(model):
    # 1. L·∫•y d·ªØ li·ªáu th·ªùi gian th·ª±c t·ª´ c√°c ngu·ªìn kh√°c nhau
    # L·∫•y t·ªëc ƒë·ªô trung b√¨nh v√† th·ªùi gian ƒë√®n xanh (gi·∫£ l·∫≠p t·ª´ Google Maps)
    avg_speed, green_time = get_google_maps_speed(MAP_URL)
    # L·∫•y nhi·ªát ƒë·ªô v√† t√¨nh tr·∫°ng m∆∞a (gi·∫£ l·∫≠p)
    temp, rain = get_fake_weather()
    # ∆Ø·ªõc t√≠nh s·ªë l∆∞·ª£ng ph∆∞∆°ng ti·ªán (gi·∫£ l·∫≠p)
    moto, car, bus = estimate_traffic_counts(avg_speed)

    now = datetime.now()
    # T·∫°o m·ªôt h√†ng d·ªØ li·ªáu ƒë·∫∑c tr∆∞ng m·ªõi cho d·ª± ƒëo√°n
    row = {
        "timestamp": now,
        "avg_speed": avg_speed,
        "green_time": green_time,
        "rain": rain,
        "temp": temp,
        "event_flag": 0,                # Gi·∫£ ƒë·ªãnh kh√¥ng c√≥ s·ª± ki·ªán ƒë·∫∑c bi·ªát
        "hour_of_day": now.hour,
        "day_of_week": now.weekday(),   # Th·ª© trong tu·∫ßn (0=Th·ª© Hai, 6=Ch·ªß Nh·∫≠t)
        "is_holiday": 0,                # Gi·∫£ ƒë·ªãnh kh√¥ng ph·∫£i ng√†y l·ªÖ
        "motorbike_count": moto,
        "car_count": car,
        "bus_count": bus,
        "minute": now.minute
    }

    # T·∫°o DataFrame t·ª´ h√†ng d·ªØ li·ªáu m·ªõi
    df = pd.DataFrame([row])
    # D·ª± ƒëo√°n l∆∞u l∆∞·ª£ng giao th√¥ng c√≥ tr·ªçng s·ªë ('flow_weighted')
    df["flow_weighted_pred"] = model.predict(df[FEATURES])

    # H√†m ph√¢n lo·∫°i m·ª©c ƒë·ªô t·∫Øc ngh·∫Ωn d·ª±a tr√™n gi√° tr·ªã d·ª± ƒëo√°n
    def classify(flow):
        if flow < 400: return "Th·∫•p"
        elif flow < 650: return "V·ª´a ph·∫£i"
        elif flow < 900: return "Cao"
        else: return "T·∫Øc ngh·∫Ωn n·∫∑ng üö®"

    # √Åp d·ª•ng h√†m ph√¢n lo·∫°i v√†o c·ªôt d·ª± ƒëo√°n
    df["congestion_level"] = df["flow_weighted_pred"].apply(classify)

    # In k·∫øt qu·∫£ d·ª± ƒëo√°n
    print("\n--- D·ª∞ ƒêO√ÅN GIAO TH√îNG ---")
    print(df[["timestamp", "flow_weighted_pred", "congestion_level"]])

# =====================================================
# 6. H√ÄM CH√çNH (MAIN)
# =====================================================

if __name__ == "__main__":
    # 1. Hu·∫•n luy·ªán/t·∫£i m√¥ h√¨nh
    model = load_or_train_model()
    # 2. Th·ª±c hi·ªán d·ª± ƒëo√°n th·ªùi gian th·ª±c
    predict_realtime(model)